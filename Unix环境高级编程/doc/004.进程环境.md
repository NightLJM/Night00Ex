## **004.进程环境**

**4.1 进程终止**

**1) 正常终止**
  1. 从main返回
  2. 调用exit
  3. 调用_exit或_Exit
  4. 最后一个线程从其启动例程返回
  5. 从最后一个线程调用pthread_exit　　　　

**2) 异常终止**
  1. 调用abort
  2. 接到一个信号
  3. 最后一个线程对取消请求做出相应　　　

**3) 终止函数**
  1. void exit(int status)
  2. void _Exit(int status)
  3. void _exit(int status)
  4. exit和_Exit定义在<stdlib.h>中，_exit定义在<unistd.h>中
  5. 上述三个函数用于正常终止一个程序，_exit和_Exit立即进入内核，exit则执行一些清理处理再进入内核。
  6. exit函数总是执行一个标准IO库的清理关闭操作：对于所有打开流调用fclose，这造成输出缓冲中的所有数据都被冲洗(写到文件上)
  7. status是终止状态。如果调用这些函数时不带终止状态，或者main执行了一个无返回值的return语句，或者main没有声明返回值为整型，则进程终止状态都是未定义的
  8. main函数返回一个整型值，与用该整型值调用exit是等价的。

**4) 终止处理函数**
  1. ISO C规定，一个进程可以登记最多32个处理函数，这些函数由exit自动调用。这些函数便是终止处理函数，通过atexit可以登记这些函数
  2. int atexit(void (*func)(void));
  3. 返回值：成功返回0，失败返回非0
  4. exit调用终止处理函数的顺序和登记它们的顺序相反，同一个函数登记多次，也会调用多次
  5. exit会调用各个终止处理函数，然后关闭所有的打开流
  6. 内核使程序执行的唯一方法是调用exec函数，进程资源终止的唯一方法是显示调用或隐式调用(通过exit)_exit或_Exit。进程也可非自愿由一个信号使其终止。

**4.2 环境表**
  1. 每个程序都接到一张环境表，环境表是一个字符指针数组。全局变量environ里面包含了该指针数组的指针：extern char** environ
  2. 通常通过getenv和putenv函数访问特定的环境变量，但是如果想要查看整个环境，就需要访问environ指针

**4.3 C程序的存储空间布局**
  1. 正文段：CPU执行的机器指令部分，可共享的，所以即使是频繁执行的程序在存储器中也只需要一个正文副本；正文通常是只读的
  2. 初始化数据段：通常称这段为数据段，它包含了程序中需要明确赋予初值的变量。如在所有函数外的声明：int max = 99;
  3. 未初始化数据段：通常称这段为bss段，程序开始执行前，bss段里的数据会被初始化为0或空指针；如在所有函数外的声明：int sum[100];
  4. 栈段：保存调用函数的地址与临时变量的地址
  5. 堆段：动态分配的内存都在这里　　　

**4.4 共享库**
  1. 又叫动态链接库。程序第一次执行或者第一次调用某个库函数时进行链接。
  2. 使用动态链接库可以减少程序文件所占空间。

**4.5 存储空间分配**











